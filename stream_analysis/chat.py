'''
# message_groups - messages
## message_types - text_message
```json
{
    "action_type": "add_chat_item",
    "author": {
        "badges": [
            {
                "icons": [
                {
                    "id": "source",
                    "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a"
                },
                {
                    "height": 16,
                    "id": "16x16",
                    "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s16-c-k",
                    "width": 16
                },
                {
                    "height": 32,
                    "id": "32x32",
                    "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s32-c-k",
                    "width": 32
                }
                ],
                "title": "Member (1 month)"
            }
            ],
            "id": "UCnK3snNwdLNDhRoRoZHnHzA",
            "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/k_LWA9booIrh8T-kKnfl_OKXNH8aB2Q_e30SCmSiHq08LxOtIKJryT1El6vu-gUiTZatgwMUMyQ"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/k_LWA9booIrh8T-kKnfl_OKXNH8aB2Q_e30SCmSiHq08LxOtIKJryT1El6vu-gUiTZatgwMUMyQ=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/k_LWA9booIrh8T-kKnfl_OKXNH8aB2Q_e30SCmSiHq08LxOtIKJryT1El6vu-gUiTZatgwMUMyQ=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "Izun-ID"
    },
    "emotes": [
        {
            "id": "UCDHABijvPBnJm7F-KlNME3w/MEWhZrGwJP28_9EPxOO16Ao",
            "images": [
                {
                    "id": "source",
                    "url": "https://yt3.ggpht.com/397Qwe2JQikqNfTKLpytHdqLJjWdvq-Ez4srcyqFXe6M8I1M8aVTpz1utn0yaXP74PXsZz_d"
                },
                {
                    "height": 24,
                    "id": "24x24",
                    "url": "https://yt3.ggpht.com/397Qwe2JQikqNfTKLpytHdqLJjWdvq-Ez4srcyqFXe6M8I1M8aVTpz1utn0yaXP74PXsZz_d=w24-h24-c-k-nd",
                    "width": 24
                },
                {
                    "height": 48,
                    "id": "48x48",
                    "url": "https://yt3.ggpht.com/397Qwe2JQikqNfTKLpytHdqLJjWdvq-Ez4srcyqFXe6M8I1M8aVTpz1utn0yaXP74PXsZz_d=w48-h48-c-k-nd",
                    "width": 48
                }
            ],
            "is_custom_emoji": true,
            "name": ":_popocheer:",
            "search_terms": [
                "_popocheer",
                "popocheer"
            ],
            "shortcuts": [
                ":_popocheer:",
                ":popocheer:"
            ]
        }
    ],
    "message": "GIGI:_popocheer:GIGI:_popocheer:GIGI:_popocheer:",
    "message_id": "ChwKGkNPRF9qNUxUb0lnREZZMEVyUVlkb1cwMHR3",
    "message_type": "text_message",
    "time_in_seconds": -36,
    "time_text": "-0:36",
    "timestamp": 1725156062136247
}
```

# message_groups - superchat
the new to superchat will have 'lower_bumper' field

## message_types - membership_item
### membership_item - new member
```json
{
    "action_type": "add_chat_item",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/RZGM_gzZhne6CvsMHrWR97FVL-qVMUI_zGiMK_NMW21EGvzBej6bg_wzO3BP8izaJlyBW66w"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/RZGM_gzZhne6CvsMHrWR97FVL-qVMUI_zGiMK_NMW21EGvzBej6bg_wzO3BP8izaJlyBW66w=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/RZGM_gzZhne6CvsMHrWR97FVL-qVMUI_zGiMK_NMW21EGvzBej6bg_wzO3BP8izaJlyBW66w=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "New member"
            }
        ],
        "id": "UCoXscU1wMuDYcvouAo8X9qQ",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/OT-xYD64qInb5FSvmZZ6LgSquajbLF6lepF8lwlhcLxLVkLR9fTvEiBif1bHCALghoE2rxTlVQ"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/OT-xYD64qInb5FSvmZZ6LgSquajbLF6lepF8lwlhcLxLVkLR9fTvEiBif1bHCALghoE2rxTlVQ=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/OT-xYD64qInb5FSvmZZ6LgSquajbLF6lepF8lwlhcLxLVkLR9fTvEiBif1bHCALghoE2rxTlVQ=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "[SSRB] EstyDs"
    },
    "header_secondary_text": "Welcome to gregg!",
    "message": null,
    "message_id": "ChwKGkNKZUY0dWZVb0lnREZZUTZzd0Fka09vQktn",
    "message_type": "membership_item",
    "time_in_seconds": 409.707,
    "time_text": "6:49",
    "timestamp": 1725156510174469
}
```
### membership_item - member monthly message
```json
{
    "action_type": "add_chat_item",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "Member (1 month)"
            }
        ],
        "id": "UCOZdIkh1y9rxraT-XBXsPqQ",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/ytc/AIdro_lN1r14JyVE1HV827fOA4jwcUpML9JATe2vub3wBZwgdO1_u1mEpcWHSejRd9oj5lcaaA"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/ytc/AIdro_lN1r14JyVE1HV827fOA4jwcUpML9JATe2vub3wBZwgdO1_u1mEpcWHSejRd9oj5lcaaA=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/ytc/AIdro_lN1r14JyVE1HV827fOA4jwcUpML9JATe2vub3wBZwgdO1_u1mEpcWHSejRd9oj5lcaaA=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "Amia the Smol"
    },
    "header_primary_text": "Member for 1 month",
    "header_secondary_text": "grem",
    "message": "FIST-sekai story",
    "message_id": "Ci8KLUNLS3ppTGp3a1lnREZaU0tGQWdkWS1RRlRnLUxveU1lc0lELTM0NTAzMTIwMg%3D%3D",
    "message_type": "membership_item",
    "time_in_seconds": -83,
    "time_text": "-1:23",
    "timestamp": 1725156014929505
}
```
## message_types - paid_message
```json
{
    "action_type": "add_chat_item",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "Member (1 month)"
            }
        ],
        "id": "UC03S0PmTbrwdY5QrR9t1Bxw",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/CnDcMv05cl1G_lupEfhTgDsS6IkW32rBS2WoFKswPGjLqizRzQaKGqP8S7aal5xtsugHU90q-T4"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/CnDcMv05cl1G_lupEfhTgDsS6IkW32rBS2WoFKswPGjLqizRzQaKGqP8S7aal5xtsugHU90q-T4=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/CnDcMv05cl1G_lupEfhTgDsS6IkW32rBS2WoFKswPGjLqizRzQaKGqP8S7aal5xtsugHU90q-T4=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "Tag3rd \u3010\u30bf\u30b0\u3011",
        "name_text_colour": "#ffffffb3"
    },
    "body_background_colour": "#e62117ff",
    "body_text_colour": "#ffffffff",
    "creator_heart_button": {
        "creatorHeartViewModel": {
            "creatorThumbnail": {
                "sources": [
                    {
                        "url": "https://yt3.ggpht.com/AD2BC7S_QlNSZEHrM-pyRR0C9DOPnfK2OnuFjTK8F842WydS1HDMe6TvhESY9Er96Kt3yu0-fQ=s48-c-k-c0x00ffffff-no-rj"
                    }
                ]
            },
            "engagementStateKey": "EktsaXZlLWNoYXQtbWVzc2FnZS1lbmdhZ2VtZW50LXN0YXRlLUNod0tHa05MTjJWNlVGaFRiMGxuUkVaVWEwc3haMEZrY2taclJXdEIgLCgB",
            "heartedAccessibilityLabel": "Remove heart",
            "heartedHoverText": "\u2764 by Gigi Murin Ch. hololive-EN",
            "heartedIcon": {
                "sources": [
                    {
                        "clientResource": {
                            "imageName": "full_heart-filled"
                        }
                    }
                ]
            },
            "unheartedAccessibilityLabel": "Heart",
            "unheartedIcon": {
                "processor": {
                    "borderImageProcessor": {
                        "imageTint": {
                            "color": 4294967295
                        }
                    }
                },
                "sources": [
                    {
                        "clientResource": {
                            "imageName": "full_heart"
                        }
                    }
                ]
            }
        }
    },
    "emotes": [
        {
            "id": "UCDHABijvPBnJm7F-KlNME3w/PhSkZrn0Ev28_9EPi_LBmAU",
            "images": [
                {
                    "id": "source",
                    "url": "https://yt3.ggpht.com/k4i2qZMFUHNvO3tJ2uFVQpcTgITFe8RFQW2TM1mOOwOKSm37KpJ1jfuFh-tL9zntqrariKDo"
                },
                {
                    "height": 24,
                    "id": "24x24",
                    "url": "https://yt3.ggpht.com/k4i2qZMFUHNvO3tJ2uFVQpcTgITFe8RFQW2TM1mOOwOKSm37KpJ1jfuFh-tL9zntqrariKDo=w24-h24-c-k-nd",
                    "width": 24
                },
                {
                    "height": 48,
                    "id": "48x48",
                    "url": "https://yt3.ggpht.com/k4i2qZMFUHNvO3tJ2uFVQpcTgITFe8RFQW2TM1mOOwOKSm37KpJ1jfuFh-tL9zntqrariKDo=w48-h48-c-k-nd",
                    "width": 48
                }
            ],
            "is_custom_emoji": true,
            "name": ":_gigilove:",
            "search_terms": [
                "_gigilove",
                "gigilove"
            ],
            "shortcuts": [
                ":_gigilove:",
                ":gigilove:"
            ]
        }
    ],
    "header_background_colour": "#d00000ff",
    "header_text_colour": "#ffffffff",
    "message": "Gi Murin! Hope you have fun with the RP today :_gigilove:",
    "message_id": "ChwKGkNLN2V6UFhTb0lnREZUa0sxZ0FkckZrRWtB",
    "message_type": "paid_message",
    "money": {
        "amount": 100.0,
        "currency": "USD",
        "currency_symbol": "$",
        "text": "$100.00"
    },
    "text_input_background_colour": "#00000030",
    "time_in_seconds": -88,
    "time_text": "-1:28",
    "timestamp": 1725156010465162,
    "timestamp_colour": "#ffffff80"
}
```
## message_types - paid_sticker
```json
{
    "action_type": "add_chat_item",
    "author": {
        "id": "UCuka9ib00EAFPQIZu2yLD9Q",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/QnCpNSu8avnOAT6PzdqR2YF8bEXjG4r5WGNuami94-Kw0tEyOvzz1cl9ubOhy8o54T-zunwyoQ"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/QnCpNSu8avnOAT6PzdqR2YF8bEXjG4r5WGNuami94-Kw0tEyOvzz1cl9ubOhy8o54T-zunwyoQ=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/QnCpNSu8avnOAT6PzdqR2YF8bEXjG4r5WGNuami94-Kw0tEyOvzz1cl9ubOhy8o54T-zunwyoQ=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "マル丸",
        "name_text_colour": "#000000b3"
    },
    "background_colour": "#00e5ffff",
    "header_overlay_image": [
        {
            "id": "source",
            "url": "https://www.gstatic.com/youtube/img/pdg/novelty/1st_purchase_celebration_novelty_animation/1st_Purchase_Celebration_Novelty_STK_IL_T2_v1.webp"
        },
        {
            "height": 64,
            "id": "90x64",
            "url": "https://www.gstatic.com/youtube/img/pdg/novelty/1st_purchase_celebration_novelty_animation/1st_Purchase_Celebration_Novelty_STK_IL_T2_v1.webp",
            "width": 90
        }
    ],
    "lower_bumper": {
        "liveChatItemBumperViewModel": {
            "content": {
                "bumperUserEduContentViewModel": {
                    "image": {
                        "sources": [
                            {
                                "clientResource": {
                                    "imageColor": 4294901760,
                                    "imageName": "CELEBRATION"
                                }
                            }
                        ]
                    },
                    "text": {
                        "content": "Let's celebrate their 1st Super on a live stream",
                        "styleRuns": [
                            {
                                "length": 48,
                                "startIndex": 0
                            }
                        ]
                    },
                    "trackingParams": "CBIQk5YLIhMIk6CfuvS3iAMVJVn1BR2F4wnq"
                }
            },
            "pdgPurchasedBumperLoggingDirectives": {
                "loggingDirectives": {
                    "trackingParams": "CBEQ784LIhMIk6CfuvS3iAMVJVn1BR2F4wnq",
                    "visibility": {
                        "types": "12"
                    }
                }
            }
        }
    },
    "message": null,
    "message_id": "ChwKGkNLT0xycVREbDRnREZXc0VyUVlkUjljVDVR",
    "message_type": "paid_sticker",
    "money": {
        "amount": 200.0,
        "currency": "JPY",
        "currency_symbol": "¥",
        "text": "¥200"
    },
    "money_chip_background_colour": "#00e5ffff",
    "money_chip_text_colour": "#000000ff",
    "sticker_images": [
        {
            "id": "source",
            "url": "https://lh3.googleusercontent.com/fxpn6BjHNVZBeeWA2SHSa6K4XFvrhVg1K1yDxdlL9bFuc9rRxkwBrNN2ASAZLQa3ZCkYshvO2rqiznfSVA"
        },
        {
            "height": 72,
            "id": "72x72",
            "url": "https://lh3.googleusercontent.com/fxpn6BjHNVZBeeWA2SHSa6K4XFvrhVg1K1yDxdlL9bFuc9rRxkwBrNN2ASAZLQa3ZCkYshvO2rqiznfSVA=s72-rwa",
            "width": 72
        },
        {
            "height": 144,
            "id": "144x144",
            "url": "https://lh3.googleusercontent.com/fxpn6BjHNVZBeeWA2SHSa6K4XFvrhVg1K1yDxdlL9bFuc9rRxkwBrNN2ASAZLQa3ZCkYshvO2rqiznfSVA=s144-rwa",
            "width": 144
        }
    ],
    "time_in_seconds": 13.369,
    "time_text": "0:13",
    "timestamp": 1724842578111189
}
```
## message_types - sponsorships_gift_purchase_announcement
```json
{
    "action_type": "add_chat_item",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/xoH32msp0CjzGqtgn_a7zo6YBUldlMUbAV-5BI-w_6Njma5E4QaC2I79w6VKh9wSQCPaiu_a=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "Member (1 month)"
            }
        ],
        "id": "UCehWbQJPPsNuzbed8bw9hnQ",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/ytc/AIdro_kEFrn2zmg1ceh8HP4c_eEd-cVWWR-5m8mBwtNS4TBhAQ"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/ytc/AIdro_kEFrn2zmg1ceh8HP4c_eEd-cVWWR-5m8mBwtNS4TBhAQ=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/ytc/AIdro_kEFrn2zmg1ceh8HP4c_eEd-cVWWR-5m8mBwtNS4TBhAQ=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "Frigid"
    },
    "message": "Gifted 10 Gigi Murin Ch. hololive-EN memberships",
    "message_id": "ChwKGkNPSE1zdDdTb0lnREZXUWIxZ0FkejAwMjZ3",
    "message_type": "sponsorships_gift_purchase_announcement",
    "time_in_seconds": 0.0,
    "time_text": "0:00",
    "timestamp": 1725155962057013
}
```

# message_groups - tickers
superchat messages which appear ticker (at the top)

## message_types - ticker_paid_sticker_item
```json
{
    "action_type": "add_live_chat_ticker_item",
    "author": {
        "id": "UC7G3b4sw4Ms0opD3uiMq9Bg",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/lLcDrnbl547beeJg8Iqyo5PXPtQO84vOqf1v50KaIFnh76-iCGEQnGws7eF4YdoutaHRuZTV"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/lLcDrnbl547beeJg8Iqyo5PXPtQO84vOqf1v50KaIFnh76-iCGEQnGws7eF4YdoutaHRuZTV=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/lLcDrnbl547beeJg8Iqyo5PXPtQO84vOqf1v50KaIFnh76-iCGEQnGws7eF4YdoutaHRuZTV=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "月下の狂犬",
        "name_text_colour": "#0000008a"
    },
    "background_colour": "#ffca28ff",
    "end_background_colour": "#ffb300ff",
    "message": null,
    "message_id": "ChwKGkNPN281dHpEbDRnREZXN0N3Z1FkRXBzcG5n",
    "message_type": "ticker_paid_sticker_item",
    "money": {
        "amount": 1000.0,
        "currency": "JPY",
        "currency_symbol": "¥",
        "text": "¥1,000"
    },
    "money_chip_background_colour": "#ffca28ff",
    "money_chip_text_colour": "#000000df",
    "start_background_colour": "#ffca28ff",
    "sticker_images": [
        {
            "id": "source",
            "url": "https://lh3.googleusercontent.com/Yj6rzvUaC591kgcbp6YLj53HJP6BswTniySl4xoQlygU1luGaMTFeGUMe5oUAC96mrssuoUw5qoqpZzBRDA"
        },
        {
            "height": 104,
            "id": "104x104",
            "url": "https://lh3.googleusercontent.com/Yj6rzvUaC591kgcbp6YLj53HJP6BswTniySl4xoQlygU1luGaMTFeGUMe5oUAC96mrssuoUw5qoqpZzBRDA=s104-rwa",
            "width": 104
        },
        {
            "height": 208,
            "id": "208x208",
            "url": "https://lh3.googleusercontent.com/Yj6rzvUaC591kgcbp6YLj53HJP6BswTniySl4xoQlygU1luGaMTFeGUMe5oUAC96mrssuoUw5qoqpZzBRDA=s208-rwa",
            "width": 208
        }
    ],
    "ticker_duration": 300,
    "ticker_icons": [
        {
            "id": "source",
            "url": "https://lh3.googleusercontent.com/R3GMKr3HlbWPhmhZkNZ1HKOdZIMKbhC5V6pqmG-g6qaeX4Xu3_suFwHH-PnwavTjHMG5yvAmbsWi421sAw"
        },
        {
            "height": 32,
            "id": "32x32",
            "url": "https://lh3.googleusercontent.com/R3GMKr3HlbWPhmhZkNZ1HKOdZIMKbhC5V6pqmG-g6qaeX4Xu3_suFwHH-PnwavTjHMG5yvAmbsWi421sAw=s32-rp",
            "width": 32
        },
        {
            "height": 64,
            "id": "64x64",
            "url": "https://lh3.googleusercontent.com/R3GMKr3HlbWPhmhZkNZ1HKOdZIMKbhC5V6pqmG-g6qaeX4Xu3_suFwHH-PnwavTjHMG5yvAmbsWi421sAw=s64-rp",
            "width": 64
        }
    ],
    "time_in_seconds": 134,
    "time_text": "2:14",
    "timestamp": 1724842699491888
}

## message_types - ticker_paid_message_item
```json
{
    "action_type": "add_live_chat_ticker_item",
    "amount_text_colour": "#ffffffff",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/w5z7G1hZUJ4btun3Xnau-ELwInRftlZ2mh6y-bSKmSqn0a6bvjx7DcYB3evgfXa4lfaEvdIzwwPIvwMt"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/w5z7G1hZUJ4btun3Xnau-ELwInRftlZ2mh6y-bSKmSqn0a6bvjx7DcYB3evgfXa4lfaEvdIzwwPIvwMt=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/w5z7G1hZUJ4btun3Xnau-ELwInRftlZ2mh6y-bSKmSqn0a6bvjx7DcYB3evgfXa4lfaEvdIzwwPIvwMt=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "Member (3 years)"
            }
        ],
        "id": "UC1k8QQG7z-x9tBWJWvPvJVA",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/VGD7Deqo2IgE9ZjVC7A7wC4LBpENDRdTNNjsigHeCxUkc5bHsQPafrL6LsY3-sc-CRInn9oLFlI"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/VGD7Deqo2IgE9ZjVC7A7wC4LBpENDRdTNNjsigHeCxUkc5bHsQPafrL6LsY3-sc-CRInn9oLFlI=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/VGD7Deqo2IgE9ZjVC7A7wC4LBpENDRdTNNjsigHeCxUkc5bHsQPafrL6LsY3-sc-CRInn9oLFlI=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "ホウサンダデザン",
        "name_text_colour": "#ffffffb3"
    },
    "body_background_colour": "#e62117ff",
    "body_text_colour": "#ffffffff",
    "creator_heart_button": {
        "creatorHeartViewModel": {
            "creatorThumbnail": {
                "sources": [
                    {
                        "url": "https://yt3.ggpht.com/ytc/AIdro_kaZLtKaya9TSJr3M4lpzV95R2rWdQtGk67fwedroUfSnE=s48-c-k-c0x00ffffff-no-rj"
                    }
                ]
            },
            "engagementStateKey": "EktsaXZlLWNoYXQtbWVzc2FnZS1lbmdhZ2VtZW50LXN0YXRlLUNod0tHa05LY1hKNmIxTXliRFJuUkVaVmNrTjNaMUZrYWpaUk1uVlIgLCgB",
            "heartedAccessibilityLabel": "Remove heart",
            "heartedHoverText": "❤ by Aqua Ch. 湊あくあ",
            "heartedIcon": {
                "sources": [
                    {
                        "clientResource": {
                            "imageName": "full_heart-filled"
                        }
                    }
                ]
            },
            "unheartedAccessibilityLabel": "Heart",
            "unheartedIcon": {
                "processor": {
                    "borderImageProcessor": {
                        "imageTint": {
                            "color": 4294967295
                        }
                    }
                },
                "sources": [
                    {
                        "clientResource": {
                            "imageName": "full_heart"
                        }
                    }
                ]
            }
        }
    },
    "end_background_colour": "#d00000ff",
    "header_background_colour": "#d00000ff",
    "header_text_colour": "#ffffffff",
    "message": "この数年間、あくたんが与えてくれた喜びに心から感謝しています。あくたんに出会えたことは、私の人生で最も幸せで幸運なことです。毎日あくたんの配信が楽しみで、雑談、ゲーム、歌、すべて大好きです。あくたんの声に癒され、オリジナル曲からも努力の力をもらえました。これからの人生が幸せで満ち溢れる、万事順調でありますようにお祈りします。今までありがとうございました、6年間お疲れ様でした。あくたんのことは絶対に忘れません。卒業おめでとう、いってらっしゃい。(日本語が苦手で申し訳ありませ)",
    "message_id": "ChwKGkNKcXJ6b1MybDRnREZVckN3Z1FkajZRMnVR",
    "message_type": "ticker_paid_message_item",
    "money": {
        "amount": 1500.0,
        "currency": "TWD",
        "currency_symbol": "NT$",
        "text": "NT$1,500.00"
    },
    "start_background_colour": "#e62117ff",
    "text_input_background_colour": "#00000030",
    "ticker_duration": 3600,
    "time_in_seconds": -3526,
    "time_text": "-58:46",
    "timestamp": 1724839034708329,
    "timestamp_colour": "#ffffff80"
}
```
## message_types - ticker_sponsor_item
```json
{
    "action_type": "add_live_chat_ticker_item",
    "author": {
        "badges": [
            {
                "icons": [
                    {
                        "id": "source",
                        "url": "https://yt3.ggpht.com/A7z3O6-V5fqP9Iqir9mCx0ZtclhD_Hd9hEt6maeUUQvkn4oZa9eL5g0c410LMJP52BnVjC7X9IgdAdQ"
                    },
                    {
                        "height": 16,
                        "id": "16x16",
                        "url": "https://yt3.ggpht.com/A7z3O6-V5fqP9Iqir9mCx0ZtclhD_Hd9hEt6maeUUQvkn4oZa9eL5g0c410LMJP52BnVjC7X9IgdAdQ=s16-c-k",
                        "width": 16
                    },
                    {
                        "height": 32,
                        "id": "32x32",
                        "url": "https://yt3.ggpht.com/A7z3O6-V5fqP9Iqir9mCx0ZtclhD_Hd9hEt6maeUUQvkn4oZa9eL5g0c410LMJP52BnVjC7X9IgdAdQ=s32-c-k",
                        "width": 32
                    }
                ],
                "title": "Member (1 year)"
            }
        ],
        "id": "UCkxz7FtWfEI2Ti6txGuiBoQ",
        "images": [
            {
                "id": "source",
                "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA"
            },
            {
                "height": 32,
                "id": "32x32",
                "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA=s32-c-k-c0x00ffffff-no-rj",
                "width": 32
            },
            {
                "height": 64,
                "id": "64x64",
                "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA=s64-c-k-c0x00ffffff-no-rj",
                "width": 64
            }
        ],
        "name": "kotoha"
    },
    "detail_text_colour": "#ffffffff",
    "end_background_colour": "#0b8043ff",
    "header_secondary_text": "Welcome to あくあクルー!",
    "message": null,
    "message_id": "ChwKGkNJVDlnT1RFbDRnREZXN0N3Z1FkRXBzcG5n",
    "message_type": "ticker_sponsor_item",
    "sponsor_icons": [
        {
            "id": "source",
            "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA"
        },
        {
            "height": 32,
            "id": "32x32",
            "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA=s32-c-k-c0x00ffffff-no-rj",
            "width": 32
        },
        {
            "height": 64,
            "id": "64x64",
            "url": "https://yt4.ggpht.com/GwqTVEDObuqR6rWwV11pL4NDuL2VUae8kRbLinqwv_OH4eHVzI8kGqSD9lhzYUiluic8EXeYKA=s64-c-k-c0x00ffffff-no-rj",
            "width": 64
        }
    ],
    "start_background_colour": "#0f9d58ff",
    "ticker_duration": 300,
    "time_in_seconds": 405,
    "time_text": "6:45",
    "timestamp": 1724842969681543
}
```

# message_groups - banners
## message_types - banner
```json
```
## message_types - banner_header
```json
```

# message_groups - donations
## message_types - donation_announcement
```json
```

# message_groups - engagement
message saying live chat replay is on

## message_types - viewer_engagement_message
```json
{
    "action_type": "add_chat_item",
    "icon": "YOUTUBE_ROUND",
    "message": "Live chat replay is on. Messages that appeared when the stream was live will show up here.",
    "message_id": "CiMKIVJFUExBWV9WRU0yMDI0LzA5LzEwLTAwOjI1OjIzLjEwNA%3D%3D",
    "message_type": "viewer_engagement_message",
    "time_in_seconds": 0.0,
    "time_text": "0:00",
    "timestamp": 1725953123104688
}
```

# message_groups - purchases
## message_types - purchased_product_message
```json
```

# message_groups - mode_changes
## message_types - mode_change_message
```json
```

# message_groups - deleted
## message_types - deleted_message
```json
```

# message_groups - bans
## message_types - ban_user
```json
```

# message_groups - placeholder
## message_types - placeholder_item
```json
```

because the tickers was following superchat tho, we dont need it.
and action_types=['add_chat_item', 'add_live_chat_ticker_item']; 'add_live_chat_ticker_item' was only appeard after superchat
so, we dont need it either.

according to the above json structure, we can summrize a normal data structure like below:
the messages
- author_id
- author_name
- author_title
- auther_membership_duration
- author_badge
- author_image

- message
- message_without_emotes
- cleaned_message
- message_type

- money(USD)

- time_in_seconds
- timestamp

the paid event
- member joined
- gifted
- superchat
'''
from functools import cached_property, reduce
import pandas as pd
from stream_analysis.env_ import Env_
from stream_analysis.types.message import Message
from chat_downloader import ChatDownloader


class Chat:
    _env: Env_
    _df_raw: pd.DataFrame = None
    _range_interval: int = 3

    def __init__(self, _env: Env_) -> None:
        self._env = _env

    def get(self) -> pd.DataFrame:
        if self._df_raw is None:

            downloader = ChatDownloader()
            chat = downloader.get_chat(
                self._env.video_live_url,
                message_groups=['messages', 'superchat'])

            messages = []
            chunk_size = 1000
            for data in chat:
                # 不使用直播開始前資料
                if data.get('time_in_seconds', -1) < 0:
                    continue
                message = Message(data, self._env)
                messages.append(message.to_dataframe())

                if len(messages) >= chunk_size:
                    if self._df_raw is None:
                        self._df_raw = pd.concat(messages, ignore_index=True)
                    else:
                        self._df_raw = pd.concat(
                            [self._df_raw, pd.concat(messages, ignore_index=True)])

                    messages = []

            if messages:
                self._df_raw = pd.concat(
                    [self._df_raw, pd.concat(messages, ignore_index=True)])
                messages = []

            self._df_raw['time_in_minutes'] = (
                self._df_raw['time_in_seconds'] // 60).astype(int)
            self._df_raw = self._df_raw.sort_values('time_in_seconds')

        return self._df_raw

    @cached_property
    def df_raw(self) -> pd.DataFrame:
        return self.get()

    @cached_property
    def df_membership_duration_avg_per_min(self) -> pd.DataFrame:
        return self.df_raw.groupby('time_in_minutes').agg(
            membership_duration_avg=('author_membership_duration', 'mean'),
        ).reset_index()

    @cached_property
    def df_money_sum_per_min(self) -> pd.DataFrame:
        return self.df_raw.groupby('time_in_minutes').agg(
            money_sum=('money', 'sum')
        ).reset_index()

    @cached_property
    def df_active_users_per_min(self) -> pd.DataFrame:
        df_active_users_per_min = self.df_raw.groupby('time_in_minutes')['author_id'].nunique()
        df_active_users_per_min = df_active_users_per_min.reset_index()
        df_active_users_per_min = df_active_users_per_min.rename(columns={'author_id':'active_users'})
        return df_active_users_per_min

    @cached_property
    def df_messages_per_min(self) -> pd.DataFrame:
        return self.df_raw[self.df_raw['message'].str.len() > 0].groupby('time_in_minutes').agg(
            messages=('message', 'count'),
        ).reset_index()

    @cached_property
    def df_message_without_emotes_per_min(self) -> pd.DataFrame:
        return self.df_raw[self.df_raw['message_without_emotes'].str.len() > 0].groupby('time_in_minutes').agg(
            message_without_emotes=('message_without_emotes', 'count'),
        ).reset_index()

    @cached_property
    def df_cleaned_message_per_min(self) -> pd.DataFrame:
        return self.df_raw[self.df_raw['cleaned_message'].str.len() > 0].groupby('time_in_minutes').agg(
            cleaned_messages=('cleaned_message', 'count'),
        ).reset_index()

    @cached_property
    def df_member_message_per_min(self) -> pd.DataFrame:
        return self.df_raw[self.df_raw['author_title'] == 'member'].groupby('time_in_minutes').agg(
            member_messages=('message', 'count'),
        ).reset_index()

    @cached_property
    def df_per_min(self) -> pd.DataFrame:
        data_frames = (
            self.df_active_users_per_min,
            self.df_membership_duration_avg_per_min,
            self.df_money_sum_per_min,
            self.df_messages_per_min,
            self.df_message_without_emotes_per_min,
            self.df_cleaned_message_per_min,
            self.df_member_message_per_min,
        )
        df = reduce(
            lambda left, right: pd.merge(
                left, right, on=['time_in_minutes'], how='outer'),
            data_frames)

        df['messages_moving_avg'] = df['messages'].rolling(window=10).mean()
        df['messages_moving_avg'] = df['messages_moving_avg'].fillna(
            df['messages'].mean())
        df['is_above_average'] = df['messages'] > df['messages_moving_avg']
        return df

    @cached_property
    def messags_mean_per_min(self) -> float:
        return self.df_per_min['messages'].mean()

    @cached_property
    def messags_std_per_min(self) -> float:
        return self.df_per_min['messages'].std()

    @cached_property
    def peak_threshold(self) -> float:
        return self.messags_mean_per_min + 1.96 * self.messags_std_per_min

    @cached_property
    def df_peaks(self) -> pd.DataFrame:
        return self.df_per_min[self.df_per_min['messages'] > self.peak_threshold]

    @cached_property
    def activity_ranges(self) -> tuple:
        # .shift() 將 is_above_average 欄位的數值往後移動一個位置，這樣可以比較當前的值和前一個值。
        # .ne() 比較當前值和前一個值是否不同。如果不同，表示出現了趨勢的變化（從低於到高於，或從高於到低於）。
        # .cumsum() 累積計數，為每個趨勢變化賦予一個唯一的組別號碼將每個連續的 True 或 False 區間歸類在一起。
        peak_transitions = self.df_per_min['is_above_average'].ne(
            self.df_per_min['is_above_average'].shift()).cumsum()

        # 對每個分組，檢查該區間內的所有值是否都為 True，也就是確定這段時間都處於峰值。如果是，則返回該區間的起點和終點（x.index.min() 和 x.index.max()）
        df = self.df_per_min.groupby(peak_transitions)\
            .apply(lambda x: (x.index.min(), x.index.max()) if x['is_above_average'].all() else None).dropna()

        merged_intervals = []
        previous_start, previous_end = None, None

        # 進行連續區間判斷，超過 self._range_interval 分鐘下降則為結束
        for start, end in df:
            if previous_start is None:
                previous_start, previous_end = start, end
            elif start - previous_end <= self._range_interval:
                previous_end = end
            else:
                merged_intervals.append((previous_start, previous_end))
                previous_start, previous_end = start, end

        if previous_start is not None:
            merged_intervals.append((previous_start, previous_end))
        return merged_intervals

    @cached_property
    def hightlight_urls(self) -> list:
        return [f'{self._env.video_watching_url}/watch?v={self._env.video_id}&t={start}m' for start, end in self.activity_ranges]


if __name__ == '__main__':
    env_ = Env_(
        video_live_url='https://www.youtube.com/live/2Z9CzFwxNJI?si=EpdFBU3VS-XCXx0g')
    chat = Chat(env_)
    df = chat.get()
    df.to_csv('chat.csv', encoding='utf8')

    print(df.head())
